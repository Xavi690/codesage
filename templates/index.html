<script>
  function makePayment() {
    const email = document.getElementById("email").value.trim();
    const button = document.getElementById("pay-btn");

    if (!email) {
      alert("Please enter your email before proceeding.");
      return;
    }

    button.disabled = true;
    button.innerText = "Processing...";

    fetch("/create_order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: email })
    })
    .then(async res => {
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(errText || "Server error");
      }
      return res.json();
    })
    .then(data => {
      const options = {
        key: data.key,
        amount: data.amount,
        currency: "INR",
        name: "CodeSage",
        description: "Purchase Master Notes",
        image: "/static/logo1.jpg",  // ✅ Added to prevent Razorpay 404 error
        order_id: data.order_id,
        handler: function () {
          alert("✅ Payment successful! You’ll receive your PDF shortly.");
        },
        prefill: { email: email },
        theme: { color: "#673ab7" }
      };

      const rzp = new Razorpay(options);

      rzp.on('payment.failed', function () {
        alert("❌ Payment failed or cancelled.");
      });

      rzp.open();
    })
    .catch(err => {
      console.error("❌", err);
      alert("Something went wrong: " + err.message);
    })
    .finally(() => {
      button.disabled = false;
      button.innerText = "Proceed Receiving PDF";
    });
  }
</script>
